#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
repo_root="$(cd "$script_dir/.." && pwd)"

cli_project_path="$repo_root/src/XmlSkills.Cli"
cli_dll_name="XmlSkills.Cli.dll"
if [[ ! -f "$repo_root/src/XmlSkills.Cli/XmlSkills.Cli.csproj" ]]; then
  echo "Could not resolve XML CLI project under '$repo_root/src'." >&2
  exit 2
fi

use_published="${XMLCLI_USE_PUBLISHED:-}"
refresh_published="${XMLCLI_REFRESH_PUBLISHED:-}"
stale_check="${XMLCLI_STALE_CHECK:-0}"

if [[ "$use_published" == "1" || "$use_published" == "true" || "$use_published" == "yes" || "$use_published" == "on" ]]; then
  cache_dir="${XMLCLI_CACHE_DIR:-$repo_root/artifacts/xmlcli-cache}"
  cli_dll="$cache_dir/$cli_dll_name"
  stamp_file="$cache_dir/publish.stamp"
  need_publish=0
  if [[ ! -f "$cli_dll" ]]; then
    need_publish=1
  fi
  if [[ "$refresh_published" == "1" || "$refresh_published" == "true" || "$refresh_published" == "yes" || "$refresh_published" == "on" ]]; then
    need_publish=1
  fi

  if [[ "$need_publish" == "0" && "$stale_check" != "0" && "$stale_check" != "false" && "$stale_check" != "no" && "$stale_check" != "off" ]]; then
    if [[ ! -f "$stamp_file" ]]; then
      need_publish=1
    elif find "$repo_root/src" \
      -type f \
      \( -name '*.cs' -o -name '*.csproj' -o -name '*.props' -o -name '*.targets' -o -name '*.json' \) \
      -newer "$stamp_file" \
      -print -quit | grep -q .; then
      need_publish=1
    else
      for file in "Directory.Build.props" "Directory.Build.targets" "Directory.Packages.props" "global.json" "NuGet.config" "RoslynSkills.slnx"; do
        if [[ -f "$repo_root/$file" && "$repo_root/$file" -nt "$stamp_file" ]]; then
          need_publish=1
          break
        fi
      done
    fi
  fi

  if [[ "$need_publish" == "1" ]]; then
    dotnet publish "$cli_project_path" -c Release -o "$cache_dir" --nologo
    mkdir -p "$cache_dir"
    date -u +"%Y-%m-%dT%H:%M:%SZ" > "$stamp_file"
  fi
  dotnet "$cli_dll" "$@"
else
  dotnet_run_no_build="${XMLCLI_DOTNET_RUN_NO_BUILD:-}"
  dotnet_run_configuration="${XMLCLI_DOTNET_RUN_CONFIGURATION:-}"
  run_args=(run --project "$cli_project_path")
  if [[ -n "$dotnet_run_configuration" ]]; then
    run_args+=(-c "$dotnet_run_configuration")
  fi
  if [[ "$dotnet_run_no_build" == "1" || "$dotnet_run_no_build" == "true" || "$dotnet_run_no_build" == "yes" || "$dotnet_run_no_build" == "on" ]]; then
    run_args+=(--no-build)
  fi
  run_args+=(-- "$@")
  dotnet "${run_args[@]}"
fi
