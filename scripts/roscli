#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
repo_root="$(cd "$script_dir/.." && pwd)"

cli_project="RoslynSkills.Cli"
cli_project_path="$repo_root/src/RoslynSkills.Cli"
cli_dll_name="RoslynSkills.Cli.dll"
if [[ -f "$repo_root/src/RoslynSkills.Cli/RoslynSkills.Cli.csproj" ]]; then
  :
elif [[ -f "$repo_root/src/RoslynAgent.Cli/RoslynAgent.Cli.csproj" ]]; then
  cli_project="RoslynAgent.Cli"
  cli_project_path="$repo_root/src/RoslynAgent.Cli"
  cli_dll_name="RoslynAgent.Cli.dll"
else
  echo "Could not resolve Roslyn CLI project under '$repo_root/src'." >&2
  exit 2
fi

use_published="${ROSCLI_USE_PUBLISHED:-}"
refresh_published="${ROSCLI_REFRESH_PUBLISHED:-}"
stale_check="${ROSCLI_STALE_CHECK:-0}"

if [[ "$use_published" == "1" || "$use_published" == "true" || "$use_published" == "yes" || "$use_published" == "on" ]]; then
  cache_dir="$repo_root/artifacts/roscli-cache"
  cli_dll="$cache_dir/$cli_dll_name"
  stamp_file="$cache_dir/publish.stamp"
  need_publish=0
  if [[ ! -f "$cli_dll" ]]; then
    need_publish=1
  fi
  if [[ "$refresh_published" == "1" || "$refresh_published" == "true" || "$refresh_published" == "yes" || "$refresh_published" == "on" ]]; then
    need_publish=1
  fi

  if [[ "$need_publish" == "0" && "$stale_check" != "0" && "$stale_check" != "false" && "$stale_check" != "no" && "$stale_check" != "off" ]]; then
    if [[ ! -f "$stamp_file" ]]; then
      need_publish=1
    elif find "$repo_root/src" \
      -type f \
      \( -name '*.cs' -o -name '*.csproj' -o -name '*.props' -o -name '*.targets' -o -name '*.json' \) \
      -newer "$stamp_file" \
      -print -quit | grep -q .; then
      need_publish=1
    else
      for file in "Directory.Build.props" "Directory.Build.targets" "Directory.Packages.props" "global.json" "NuGet.config" "RoslynSkills.slnx" "RoslynSkill.slnx"; do
        if [[ -f "$repo_root/$file" && "$repo_root/$file" -nt "$stamp_file" ]]; then
          need_publish=1
          break
        fi
      done
    fi
  fi

  if [[ "$need_publish" == "1" ]]; then
    dotnet publish "$cli_project_path" -c Release -o "$cache_dir" --nologo
    mkdir -p "$cache_dir"
    date -u +"%Y-%m-%dT%H:%M:%SZ" > "$stamp_file"
  fi
  dotnet "$cli_dll" "$@"
else
  dotnet run --project "$cli_project_path" -- "$@"
fi